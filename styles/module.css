/* =========================================================
   1. 視窗主體架構 (Main Layout)
   設定聊天視窗的整體背景、排版方式
   ========================================================= */

.YCIO-floating-chat-window {
    /* --- 定義 CSS 變數預設值 --- */
    --ycio-bg: rgba(0, 0, 0, 0.8);

    display: flex;
    flex-direction: column; /* 垂直排列：分頁 -> 內容 -> 輸入框 */
    background: var(--ycio-bg);/* 視窗背景色 (預設半透明黑) */
    color: white; /* 預設文字顏色 */
    padding: 0;
}

.YCIO-floating-chat-window .window-content{
    padding: 2px;
}

/* =========================================================
   2. 分頁標籤 (Tabs)
   頂部的分頁切換區塊
   ========================================================= */

.YCIO-floating-chat-window .tabs {
    display: flex;
    border-bottom: 1px solid #555;
    padding: 0px 2px;
    
    /* 支援水平捲動 */
    overflow-x: auto;
    white-space: nowrap;
    justify-content: flex-start;
    gap: 2px;
    
    /* 隱藏醜醜的捲動條 (Webkit 瀏覽器) */
    scrollbar-width: thin; 
    scrollbar-color: #444 transparent;
}

.YCIO-floating-chat-window .tabs::-webkit-scrollbar {
    height: 2px;
}
.YCIO-floating-chat-window .tabs::-webkit-scrollbar-thumb {
    background-color: #444;
    border-radius: 2px;
}

.YCIO-floating-chat-window .tabs .item {
    padding: 0px 5px;
    font-size: 1em;  /* 字體 */
    cursor: pointer;
    color: #aaa;
    transition: color 0.2s, background 0.2s;
    white-space: nowrap; /* 確保文字不換行 */
    border-radius: 4px; /* 增加圓角 */
    border-right: 1px solid #555;
}

.YCIO-floating-chat-window .tabs .item:hover {
    color: #fff;
    background: rgba(255,255,255,0.05);
}

.YCIO-floating-chat-window .tabs .item.active {
    background: #444;
    border-radius: 4px;
    color: #fff;
    font-weight: bold;
    border-right: 2px outset #EE3;
}

/* =========================================================
   3. 聊天內容區域 (Chat Content Area)
   顯示訊息列表的主要區塊
   ========================================================= */

.YCIO-floating-chat-window .chat-content {
    flex: 1;            /* 佔滿中間剩餘空間 */
    display: flex;
    flex-direction: column;
    min-height: 0;      /* 關鍵：防止內容撐開父元素，確保 flex 正確運作 */
    overflow: hidden;   /* 隱藏溢出，讓捲動發生在內部的 #custom-chat-log */
    padding: 0px;
    position: relative; /* 讓內部的絕對定位元素 (如置底按鈕) 以此為基準 */
}

/* 訊息列表容器 (ul/ol) */
.YCIO-floating-chat-window .chat-log {
    flex: 1;
    overflow-y: auto;   /* 必須要有 auto，捲動條才會出現 */
    height: 100%;       /* 確保高度被撐滿 */
    list-style: none;   /* 移除列表的點點 */
    padding: 0px;
    margin: 0;
    overflow-anchor: auto;
}

/* 載入中的讀取條 (撈取舊訊息時顯示) */
.YCIO-floating-chat-window .loading-spinner {
    text-align: center;
    font-size: 10px;
    color: #888;
    padding: 4px;
    display: none;      /* 預設隱藏，由 JS 控制顯示 */
}

/* =========================================================
   4. 訊息樣式 (Message Bubbles)
   單條訊息的外觀、卡牌、圖片與特殊狀態
   ========================================================= */

/* 訊息外框基礎樣式 */
.YCIO-floating-chat-window .chat-message {
    background: rgb(255, 255, 255); /* 預設白底 */
    border: 1px solid #444;
    border-radius: 4px;
    /* margin-bottom 可以視需要加入，保持訊息間距 */

    display: flex;
    flex-direction: row; /* 水平排列 */
    align-items: flex-start; /* 頂部對齊 */
    gap: 4px; /* 頭像與內容的間距 */
    padding: 2px; /* 整體內縮一點 */
    
    /* 確保原本的背景色/邊框還是在最外層 */
    background: rgb(255, 255, 255); 
    border: 1.5px solid #444;
    border-radius: 4px;

}

/* 訊息標頭 (發訊者、時間等) */
.YCIO-floating-chat-window .chat-message .message-header {
    font-size: 0.85rem;
    border-bottom: 1px solid #777;
    margin-bottom: 4px;
}

/* --- 圖片與卡牌處理 --- */

/* 讓訊息內的圖片不要超出邊框 (RWD) */
.YCIO-floating-chat-window .chat-message img {
    max-width: 100%;
    height: auto;
}

/* 卡牌與物件的佈局容器 */
.YCIO-floating-chat-window .chat-message .card-draw {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 5px 0;
}

/* 限制卡牌與內容圖片的最大高度，避免洗版 */
.YCIO-floating-chat-window .chat-message .card-draw img,
.YCIO-floating-chat-window .chat-message .message-content img {
    max-height: 48px; 
    width: auto;
    object-fit: contain;
    border: none;
}

/* 單純的擲骰圖片或表情符號垂直置中 */
.YCIO-floating-chat-window .chat-message .message-content img {
    vertical-align: top;
}

/* 訊息內顯示的擲骰樣式 */
.YCIO-floating-chat-window .chat-message .message-content .dice-roll {
    min-width: 100px;
}
.YCIO-floating-chat-window .chat-message .message-content .dice-roll .dice-formula {
    padding-left: 4px;
    padding-right: 4px;
}

/* 訊息內容，主要寫用來插入圖片表符等 */
.YCIO-floating-chat-window .chat-message .message-content {
    display: flex;
    align-items: baseline;
}

/* --- 特殊訊息類型 (配色區) --- */

/* 私訊 (Whisper) - 淡紫色 */
.YCIO-floating-chat-window .chat-message.whisper {
    background: rgba(230, 220, 240); 
    border-color: #7a5d96;
}

/* 盲骰 (Blind) - 淡紅色 */
.YCIO-floating-chat-window .chat-message.blind {
    background: rgba(240, 220, 220);
    border-color: #965d5d;
}

/* 情感描述/扮演 (Emote / IC) - 灰色斜體 */
.YCIO-floating-chat-window .chat-message.emote {
    background: rgba(210, 210, 210);
    font-style: italic;
}

/* =========================================================
   5. 訊息頭像佈局 (Message Avatar Layout)
   左圖右文
   ========================================================= */

/* 2. 左側頭像區域 */
.YCIO-floating-chat-window .message-avatar {
    flex-shrink: 0; /* 防止頭像被壓縮 */
    width: 40px;    /* 頭像固定寬度 */
    height: 40px;   /* 頭像固定高度 */
    border-radius: 4px; /* 小圓角 */
    overflow: hidden;
    background: #000;
    margin-top: 2px; /* 微調對齊 */
    border: 1px solid #666;
}

.YCIO-floating-chat-window .message-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* 保持比例填滿 */
    border: none;
    display: block;
}

/* 3. 右側內容區域 (包覆原本的 header 和 content) */
.YCIO-floating-chat-window .message-body {
    flex: 1; /* 佔據剩餘空間 */
    min-width: 0; /* 關鍵：防止內容(如長網址)撐爆 Flex */
    display: flex;
    flex-direction: column;
    color: #000; /* 內部字的顏色 */
}

.YCIO-floating-chat-window .message-sender {
    color: #000; /* 內部字的顏色 */
}

/* 微調原本的 header，取消下底線(可選)，或是調整間距 */
.YCIO-floating-chat-window .chat-message .message-header {
    border-bottom: 1px solid rgba(0,0,0,0.1); /* 讓分隔線淡一點 */
    margin-bottom: 4px;
    padding-bottom: 2px;
}

/* =========================================================
   6. 輸入區域 (Input Area)
   底部的文字輸入框、發送按鈕與打字提示
   ========================================================= */

/* 頭像選擇器按鈕那一塊 */
.YCIO-floating-chat-window .speaker-row {
    display: flex;
    gap: 5px;
    align-items: center;
}

.YCIO-floating-chat-window #chat-avatar-btn {
    width: 30px;
    height: 30px;
    background: #333;
    color: #aaa;
    border: 1px solid #555;
    border-radius: 4px;
    cursor: pointer;
}

.YCIO-floating-chat-window #chat-avatar-btn.ycio-disabled {
    opacity: 0.5;               /* 變半透明 */
    filter: grayscale(100%);    /* 變灰階 (選用) */
    cursor: not-allowed;        /* 滑鼠移上去變成紅色禁止符號 */
}

.YCIO-floating-chat-window #chat-avatar-btn:hover {
    color: #fff;
    background: #444;
}

/* 頭像按鈕的 Tooltip，因為不依附在模組的視窗內，必須獨立指定 */
.YCIO-avatar-tooltip {
    transition-delay: 0s !important;   /* 移除顯示延遲，雖然好像沒卵用 */
}

/* 文字格式按鈕 */
.YCIO-floating-chat-window .chat-input-area .chat-toolbar {
    display: flex;
    position: absolute;
    right: 0;
    align-items: center;
    gap: 5px;
    padding: 2px 5px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px 4px 0 0; /* 上方圓角 */
    margin-bottom: 0;
}

.YCIO-floating-chat-window .chat-input-area .chat-toolbar button {
    color: var(--color-text-light-highlight);
    cursor: pointer;
    padding: 0px 0px;
    height: 24px;
    width: 24px;
    line-height: 24px;
}

.YCIO-floating-chat-window .chat-input-area .chat-toolbar button:hover {
    color: var(--color-text-light-heading);
    text-shadow: 0 0 5px var(--color-shadow-primary);
}

.YCIO-floating-chat-window .chat-input-area .chat-toolbar .color-control-group {
    display: flex;
    align-items: center;
    border: 1px solid #474747;
    border-radius: 2px;
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 2px;
    padding-right: 2px;
}

.YCIO-floating-chat-window .chat-input-area .chat-toolbar .color-control-group #chat-text-color-picker {
    background: none;
    color: var(--color-text-light-highlight);
    cursor: pointer;
    padding: 4px 0px;
    height: 24px;
    width: 30px;
    line-height: 24px;
}

.YCIO-floating-chat-window .chat-input-area .chat-toolbar .color-control-group #chat-text-color-picker::-webkit-color-swatch-wrapper {
    padding: 0;
}

.YCIO-floating-chat-window .chat-input-area .chat-toolbar .color-control-group #chat-text-color-picker::-webkit-color-swatch {
    border: none;
}

/* 聊天輸入框 */
.YCIO-floating-chat-window .chat-input-area {
    padding: 0px;
    padding-top: 2px;
    flex-shrink: 0;   /* 防止被擠壓，保持高度 */
    display: flex;       /* flex column 佈局 */
    flex-direction: column; 
    gap: 2px;            /* 元素間距 */
    background: rgba(0,0,0,0.2); /* 稍微加深背景，區分輸入區 */
    border-top: 1px solid #444;  /* 加上頂部邊框，視覺上更整齊 */
}

/* 身份選擇器樣式 */
.YCIO-floating-chat-window .speaker-select-wrapper {
    width: 30%;
}

.YCIO-floating-chat-window #chat-speaker-select {
    /* 使用變數，預設為淺灰 */
    color: var(--user-color, #f5f5f5);
    /* 增加文字陰影，試圖在背景顏色相近下盡量保持可見度 */
    text-shadow: 1px 1px 2px rgba(0,0,0, 1), 0 0 5px rgba(0,0,0,0.8);

    width: 100%;
    background: #333;
    border: 2px solid #555;
    border-radius: 4px;
    padding: 4px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
}

.YCIO-floating-chat-window #chat-speaker-select:hover {
    background: #444;
}

/* 定義閃爍動畫：邊框與陰影發光 */
@keyframes YCIO-flash-highlight {
    0% {
        border-color: #555;
        /* 初始狀態：無光暈 */
        box-shadow: 0 0 0 rgba(255, 215, 0, 0);
        background-color: #333;
        transform: scale(1);
    }
    50% {
        border-color: #FFD700; /* 亮金色邊框 */
        /* 外部大範圍金色光暈 + 內部金色光暈 */
        box-shadow: 0 0 25px 5px rgba(255, 215, 0, 1), inset 0 0 15px rgba(255, 215, 0, 0.8);
        /* 背景變亮 */
        background-color: #6e6218; 
        /* 稍微放大 */
        transform: scale(1.02);
    }
    100% {
        border-color: #555;
        /* 回復狀態：無光暈 */
        box-shadow: 0 0 0 rgba(255, 215, 0, 0);
        background-color: #333;
        transform: scale(1);
    }
}

.YCIO-pulse-animation {
    animation: YCIO-flash-highlight 1.2s ease-in-out;
    position: relative;
    z-index: 10;
}

/* 輸入框包覆層：用於定位發送按鈕 */
.YCIO-floating-chat-window .input-wrapper {
    position: relative;
    width: 100%;
    display: flex;
    align-items: flex-end; /* 讓按鈕跟隨輸入框底部對齊 */
    border-top-left-radius: 0;
    border-top-right-radius: 0;
}

/* 文字輸入框 (Textarea) */
.YCIO-floating-chat-window textarea {
    width: 100%;
    height: auto;       /* 自動高度 */
    min-height: 32px;   /* 最小高度 */
    background: #222;   /* 輸入框深色背景 */
    color: white;
    border: 1px solid #444;
    border-radius: 4px;
    
    /* 關鍵行為設定 */
    resize: none;       /* 禁止手動拉大，由 JS 控制 */
    overflow-y: hidden; /* 未達最大高度前隱藏捲軸 */
    padding: 6px 35px 2px 2px; /* padding-right: 40px 是為了避開右下角的發送按鈕 */
    line-height: 1.4;
    box-sizing: border-box;
}

/* 發送按鈕 (右下角小飛機/文字) */
.YCIO-floating-chat-window #chat-send-btn {
    position: absolute;
    right: 5px;
    bottom: 5px;
    
    width: auto;
    height: 30px;
    background: transparent;
    color: #888;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s;
}

.YCIO-floating-chat-window #chat-send-btn:hover {
    color: #fff;
    background: rgba(255, 255, 255, 0.1); /* 滑鼠懸停時的微亮背景 */
    border-radius: 4px;
}

/* 誰在打字提示文字 (Typing Indicator) */
.YCIO-floating-chat-window .typing-indicator {
    font-size: 12px;
    color: #aaa;        /* 淺灰色字體 */
    font-style: italic;
    height: 12px;       /* 固定高度，避免文字出現時造成版面跳動 */
    opacity: 0;         /* (依需求保留) 預設為 1，透過 class 切換或 JS 控制 */
    transition: opacity 0.3s ease; /* 淡入淡出效果 */
    pointer-events: none; /* 讓滑鼠點不到它，避免擋住下方的操作 */
}

/* 雖然原本設定 opacity:1，但保留這個 class 以便未來 JS 控制顯示狀態 */
.YCIO-floating-chat-window .typing-indicator.active {
    opacity: 1;
}

/* =========================================================
   7. 懸浮按鈕與通知 (Floating Buttons & Notifications)
   跳至底部、新訊息通知橫幅
   ========================================================= */

/* 跳至底部按鈕 (橫幅樣式) */
.YCIO-floating-chat-window .jump-to-bottom {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 35px; /* 橫幅高度 */
    
    background: rgba(40, 40, 40, 0.9); /* 深色半透明背景 */
    color: #ffd700; /* 金黃色文字，顯眼 */
    border: none;
    border-top: 1px solid #666;
    border-radius: 0; 
    
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px; 
    
    /* 預設隱藏狀態 */
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 100;       /* 確保蓋在訊息列表上方 */
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.3);
}

.YCIO-floating-chat-window .jump-to-bottom:hover {
    background: rgba(60, 60, 60, 0.95);
    color: #fff;
}

/* 顯示狀態 (由 JS 添加 .visible) */
.YCIO-floating-chat-window .jump-to-bottom.visible {
    opacity: 1;
    visibility: visible;
}

/* 按鈕文字：預設 */
.YCIO-floating-chat-window .jump-to-bottom::after {
    content: "回到底部";
}

/* --- 新訊息通知狀態 (Unread) --- */
/* 當有新訊息時的背景色 (更亮的黃色) */
.YCIO-floating-chat-window .jump-to-bottom.unread {
    background: rgba(242, 255, 105, 0.9);
    color: #000000;
}

/* 當有新訊息時的文字 */
.YCIO-floating-chat-window .jump-to-bottom.unread::after {
    content: "有新訊息";
}

/* =========================================================
   8. 頭像選擇器 (Avatar Selector Popup)
   ========================================================= */

.avatar-selector-window .window-content {
    padding: 0;
    background: #222;
}

.avatar-selector-container {
    padding: 10px;
    height: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.avatar-selector-container .controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 10px;
    border-bottom: 1px solid #444;
}

.avatar-selector-container .avatar-grid {
    flex: 1;
    display: grid;
    /* 固定最小寬度為 90px，讓卡片不要太小 */
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); 
    /* 固定行高，讓所有卡片高度一致 (圖片高度 + 詳情區高度) */
    grid-auto-rows: max-content; 
    gap: 10px;
    overflow-y: auto; /* 確保內容過多時出現捲軸 */
    padding: 5px;
    align-content: start; /* 防止 grid items 被拉伸填滿高度 */
}

/* 單個頭像項目 卡片容器 */
.avatar-card {
    display: flex;
    flex-direction: column;
    background: #111;
    border: 1px solid #444;
    border-radius: 4px;
    overflow: hidden;
    cursor: pointer;
    transition: border-color 0.2s;
    /* 不設固定高度，由內容撐開，但圖片區會保持比例 */
    position: relative;
}

/* 選中狀態 */
.avatar-card.selected {
    border: 1px solid #ffd700;
    box-shadow: 0 0 4px #ffd700;
}

/* 圖片區域 */
.avatar-card .image-wrapper {
    position: relative;
    width: 100%;
    /* 使用 padding-top 強制創造正方形 (1:1) */
    padding-top: 100%; 
    background: #000;
    overflow: hidden; /* 確保圖片不溢出 */
}

.avatar-card img {
    position: absolute; /* 脫離文檔流，避免撐開父元素 */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover; /* 保持比例填滿 */
    display: block;
}

/* 刪除按鈕 */
.avatar-card .delete-btn {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 20px;
    height: 20px;
    background: rgba(200, 0, 0, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
    cursor: pointer;
}

.avatar-card:hover .delete-btn {
    opacity: 1;
}

/* 底部詳情區 (輸入框) */
.avatar-card .details {
    padding: 0px 0px;
    background: #222;
    border-top: 2px solid #333;
    display: flex;
    align-items: center;
    justify-content: center;
    /* 固定高度確保整齊 */
    height: 30px; 
    box-sizing: border-box;
}

/* 預設標籤文字 */
.avatar-card .system-label {
    font-size: 10px;
    color: #888;
}

/* 註解輸入框 */
.avatar-card input.avatar-label-input {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 1px solid #444; 
    color: #ccc;
    font-size: 11px; /* 字稍微大一點點 */
    text-align: center;
    padding: 2px 0;
    height: 100%;
}

.avatar-card input.avatar-label-input:focus {
    outline: none;
    border-bottom-color: #ffd700;
    color: white;
}


/* 底部確認區域 */
.avatar-selector-container .footer {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #444;
}

/* 確認按鈕樣式 */
.avatar-selector-container .confirm-btn {
    width: 100%;
    padding: 8px;
    background: #333;
    color: #eee;
    border: 1px solid #555;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}

.avatar-selector-container .confirm-btn:hover {
    background: #444;
    color: #fff;
    border-color: #666;
}

/* 拖曳中的頭像卡片 (半透明 + 虛線框) */
.avatar-card.dragging {
    opacity: 0.4;
    border: 2px dashed #999;
}

/* 拖曳經過目標上方時的樣式 (提示放置位置) */
.avatar-card.drag-over {
    border: 2px solid #ffd700; /* 金色實線框 */
    transform: scale(1.02);    /* 微微放大 */
    z-index: 1;
}


/* =========================================================
   Inline Avatar Picker 樣式 
   ========================================================= */
.inline-avatar-picker-container .picker-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    gap: 2px;
    padding: 2px;
}

.inline-avatar-picker-container .picker-item {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--color-border-light-tertiary);
    border-radius: 4px;
    padding: 4px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: all 0.2s;
    height: auto; /* 覆寫預設 button 高度 */
}

.inline-avatar-picker-container .picker-item:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--color-text-hyperlink);
}

.inline-avatar-picker-container .img-wrapper {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 4px;
}

.inline-avatar-picker-container img {
    max-width: 100%;
    max-height: 100%;
    border: none;
}

.inline-avatar-picker-container .label {
    font-size: 0.8em;
    color: var(--color-text-light-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}