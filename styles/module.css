/* =========================================================
   1. 視窗主體架構 (Main Layout)
   設定聊天視窗的整體背景、排版方式
   ========================================================= */

.YCIO-floating-chat-window {
    /* --- 定義 CSS 變數預設值 --- */
    --ycio-bg: rgba(0, 0, 0, 0.8);

    display: flex;
    flex-direction: column; /* 垂直排列：分頁 -> 內容 -> 輸入框 */
    background: var(--ycio-bg);/* 視窗背景色 (預設半透明黑) */
    color: white; /* 預設文字顏色 */
}

/* =========================================================
   2. 分頁標籤 (Tabs)
   頂部的分頁切換區塊
   ========================================================= */

.YCIO-floating-chat-window .tabs {
display: flex;
    border-bottom: 1px solid #555;
    padding: 5px;
    
    /* 新增：支援水平捲動 */
    overflow-x: auto;
    white-space: nowrap;
    
    /* 隱藏醜醜的捲動條 (Webkit 瀏覽器) */
    scrollbar-width: thin; 
    scrollbar-color: #444 transparent;
}

.YCIO-floating-chat-window .tabs::-webkit-scrollbar {
    height: 4px;
}
.YCIO-floating-chat-window .tabs::-webkit-scrollbar-thumb {
    background-color: #444;
    border-radius: 2px;
}

.YCIO-floating-chat-window .tabs .item {
    padding: 5px 15px;
    cursor: pointer;
    color: #aaa;
    transition: color 0.2s, background 0.2s;
    /* 確保文字不換行 */
    white-space: nowrap; 
}

.YCIO-floating-chat-window .tabs .item:hover {
    color: #fff;
    background: rgba(255,255,255,0.05);
}

.YCIO-floating-chat-window .tabs .item.active {
    background: #444;
    border-radius: 4px;
    color: #fff;
    font-weight: bold;
}

/* =========================================================
   3. 聊天內容區域 (Chat Content Area)
   顯示訊息列表的主要區塊
   ========================================================= */

.YCIO-floating-chat-window .chat-content {
    flex: 1;            /* 佔滿中間剩餘空間 */
    display: flex;
    flex-direction: column;
    min-height: 0;      /* 關鍵：防止內容撐開父元素，確保 flex 正確運作 */
    overflow: hidden;   /* 隱藏溢出，讓捲動發生在內部的 #custom-chat-log */
    padding: 10px;
    position: relative; /* 讓內部的絕對定位元素 (如置底按鈕) 以此為基準 */
}

/* 訊息列表容器 (ul/ol) */
#custom-chat-log {
    flex: 1;
    overflow-y: auto;   /* 必須要有 auto，捲動條才會出現 */
    height: 100%;       /* 確保高度被撐滿 */
    list-style: none;   /* 移除列表的點點 */
    padding: 10px;
    margin: 0;
}

/* 載入中的讀取條 (撈取舊訊息時顯示) */
.YCIO-floating-chat-window .loading-spinner {
    text-align: center;
    font-size: 12px;
    color: #888;
    padding: 5px;
    display: none;      /* 預設隱藏，由 JS 控制顯示 */
}

/* =========================================================
   4. 訊息樣式 (Message Bubbles)
   單條訊息的外觀、卡牌、圖片與特殊狀態
   ========================================================= */

/* 訊息外框基礎樣式 */
.YCIO-floating-chat-window .chat-message {
    background: rgb(255, 255, 255); /* 預設白底 */
    border: 1px solid #444;
    border-radius: 4px;
    /* margin-bottom 可以視需要加入，保持訊息間距 */
}

/* 訊息標頭 (發訊者、時間等) */
.YCIO-floating-chat-window .chat-message .message-header {
    font-size: 0.85rem;
    border-bottom: 1px solid #777;
    margin-bottom: 4px;
}

/* --- 圖片與卡牌處理 --- */

/* 讓訊息內的圖片不要超出邊框 (RWD) */
.YCIO-floating-chat-window .chat-message img {
    max-width: 100%;
    height: auto;
}

/* 卡牌與物件的佈局容器 */
.YCIO-floating-chat-window .chat-message .card-draw {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 5px 0;
}

/* 限制卡牌與內容圖片的最大高度，避免洗版 */
.YCIO-floating-chat-window .chat-message .card-draw img,
.YCIO-floating-chat-window .chat-message .message-content img {
    max-height: 48px; 
    width: auto;
    object-fit: contain;
    border: none;
}

/* 單純的擲骰圖片或表情符號垂直置中 */
.YCIO-floating-chat-window .chat-message .message-content img {
    vertical-align: middle;
}

/* --- 特殊訊息類型 (配色區) --- */

/* 私訊 (Whisper) - 淡紫色 */
.YCIO-floating-chat-window .chat-message.whisper {
    background: rgba(230, 220, 240); 
    border-color: #7a5d96;
}

/* 盲骰 (Blind) - 淡紅色 */
.YCIO-floating-chat-window .chat-message.blind {
    background: rgba(240, 220, 220);
    border-color: #965d5d;
}

/* 情感描述/扮演 (Emote / IC) - 灰色斜體 */
.YCIO-floating-chat-window .chat-message.emote {
    background: rgba(210, 210, 210);
    font-style: italic;
}

/* =========================================================
   5. 訊息頭像佈局 (Message Avatar Layout)
   左圖右文
   ========================================================= */

/* 1. 將 list item (.message) 改為 Flex 容器 */
.YCIO-floating-chat-window .chat-message {
    display: flex;
    flex-direction: row; /* 水平排列 */
    align-items: flex-start; /* 頂部對齊 */
    gap: 8px; /* 頭像與內容的間距 */
    padding: 5px; /* 整體內縮一點 */
    
    /* 確保原本的背景色/邊框還是在最外層 */
    background: rgb(255, 255, 255); 
    border: 1px solid #444;
    border-radius: 4px;
}

/* 2. 左側頭像區域 */
.YCIO-floating-chat-window .message-avatar {
    flex-shrink: 0; /* 防止頭像被壓縮 */
    width: 40px;    /* 頭像固定寬度 */
    height: 40px;   /* 頭像固定高度 */
    border-radius: 4px; /* 小圓角 */
    overflow: hidden;
    background: #000;
    margin-top: 2px; /* 微調對齊 */
    border: 1px solid #666;
}

.YCIO-floating-chat-window .message-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* 保持比例填滿 */
    border: none;
    display: block;
}

/* 3. 右側內容區域 (包覆原本的 header 和 content) */
.YCIO-floating-chat-window .message-body {
    flex: 1; /* 佔據剩餘空間 */
    min-width: 0; /* 關鍵：防止內容(如長網址)撐爆 Flex */
    display: flex;
    flex-direction: column;
}

/* 微調原本的 header，取消下底線(可選)，或是調整間距 */
.YCIO-floating-chat-window .chat-message .message-header {
    border-bottom: 1px solid rgba(0,0,0,0.1); /* 讓分隔線淡一點 */
    margin-bottom: 4px;
    padding-bottom: 2px;
}

/* =========================================================
   6. 輸入區域 (Input Area)
   底部的文字輸入框、發送按鈕與打字提示
   ========================================================= */

/* 頭像選擇器案紐那一塊 */
.YCIO-floating-chat-window .speaker-row {
    display: flex;
    gap: 5px;
    align-items: center;
}

.YCIO-floating-chat-window #chat-avatar-btn {
    width: 30px;
    height: 30px;
    background: #333;
    color: #aaa;
    border: 1px solid #555;
    border-radius: 4px;
    cursor: pointer;
}

.YCIO-floating-chat-window #chat-avatar-btn:hover {
    color: #fff;
    background: #444;
}

.YCIO-floating-chat-window .chat-input-area {
    padding: 10px;
    flex-shrink: 0;   /* 防止被擠壓，保持高度 */
    display: flex;       /* flex column 佈局 */
    flex-direction: column; 
    gap: 5px;            /* 元素間距 */
}

/* 身份選擇器樣式 */
.YCIO-floating-chat-window .speaker-select-wrapper {
    width: 30%;
}

.YCIO-floating-chat-window #chat-speaker-select {
    width: 100%;
    background: #333;
    color: #ffd700;      /* 金色文字凸顯身份 */
    border: 1px solid #555;
    border-radius: 4px;
    padding: 4px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
}

.YCIO-floating-chat-window #chat-speaker-select:hover {
    background: #444;
}

/* 輸入框包覆層：用於定位發送按鈕 */
.YCIO-floating-chat-window .input-wrapper {
    position: relative;
    width: 100%;
    display: flex;
    align-items: flex-end; /* 讓按鈕跟隨輸入框底部對齊 */
}

/* 文字輸入框 (Textarea) */
.YCIO-floating-chat-window textarea {
    width: 100%;
    height: auto;       /* 自動高度 */
    min-height: 40px;   /* 最小高度 */
    background: #222;   /* 輸入框深色背景 */
    color: white;
    border: 1px solid #444;
    border-radius: 4px;
    
    /* 關鍵行為設定 */
    resize: none;       /* 禁止手動拉大，由 JS 控制 */
    overflow-y: hidden; /* 未達最大高度前隱藏捲軸 */
    padding: 8px 40px 8px 8px; /* padding-right: 40px 是為了避開右下角的發送按鈕 */
    line-height: 1.4;
    box-sizing: border-box;
}

/* 發送按鈕 (右下角小飛機/文字) */
.YCIO-floating-chat-window #chat-send-btn {
    position: absolute;
    right: 5px;
    bottom: 5px;
    
    width: auto;
    height: 30px;
    background: transparent;
    color: #888;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s;
}

.YCIO-floating-chat-window #chat-send-btn:hover {
    color: #fff;
    background: rgba(255, 255, 255, 0.1); /* 滑鼠懸停時的微亮背景 */
    border-radius: 4px;
}

/* 誰在打字提示文字 (Typing Indicator) */
.YCIO-floating-chat-window .typing-indicator {
    font-size: 12px;
    color: #aaa;        /* 淺灰色字體 */
    font-style: italic;
    height: 18px;       /* 固定高度，避免文字出現時造成版面跳動 */
    margin-top: 4px;
    margin-left: 5px;   
    opacity: 0;         /* (依需求保留) 預設為 1，透過 class 切換或 JS 控制 */
    transition: opacity 0.3s ease; /* 淡入淡出效果 */
    pointer-events: none; /* 讓滑鼠點不到它，避免擋住下方的操作 */
}

/* 雖然原本設定 opacity:1，但保留這個 class 以便未來 JS 控制顯示狀態 */
.YCIO-floating-chat-window .typing-indicator.active {
    opacity: 1;
}

/* =========================================================
   7. 懸浮按鈕與通知 (Floating Buttons & Notifications)
   跳至底部、新訊息通知橫幅
   ========================================================= */

/* 跳至底部按鈕 (橫幅樣式) */
.YCIO-floating-chat-window .jump-to-bottom {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 35px; /* 橫幅高度 */
    
    background: rgba(40, 40, 40, 0.9); /* 深色半透明背景 */
    color: #ffd700; /* 金黃色文字，顯眼 */
    border: none;
    border-top: 1px solid #666;
    border-radius: 0; 
    
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px; 
    
    /* 預設隱藏狀態 */
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 100;       /* 確保蓋在訊息列表上方 */
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.3);
}

.YCIO-floating-chat-window .jump-to-bottom:hover {
    background: rgba(60, 60, 60, 0.95);
    color: #fff;
}

/* 顯示狀態 (由 JS 添加 .visible) */
.YCIO-floating-chat-window .jump-to-bottom.visible {
    opacity: 1;
    visibility: visible;
}

/* 按鈕文字：預設 */
.YCIO-floating-chat-window .jump-to-bottom::after {
    content: "回到底部";
}

/* --- 新訊息通知狀態 (Unread) --- */
/* 當有新訊息時的背景色 (更亮的黃色) */
.YCIO-floating-chat-window .jump-to-bottom.unread {
    background: rgba(242, 255, 105, 0.9);
    color: #000000;
}

/* 當有新訊息時的文字 */
.YCIO-floating-chat-window .jump-to-bottom.unread::after {
    content: "有新訊息";
}

/* =========================================================
   8. 頭像選擇器 (Avatar Selector Popup)
   ========================================================= */

.avatar-selector-window .window-content {
    padding: 0;
    background: #222;
}

.avatar-selector-container {
    padding: 10px;
    height: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.avatar-selector-container .controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 10px;
    border-bottom: 1px solid #444;
}

.avatar-selector-container .avatar-grid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 10px;
    overflow-y: auto;
}

/* 單個頭像項目 */
.avatar-item {
    position: relative;
    aspect-ratio: 1 / 1;
    border: 2px solid transparent;
    border-radius: 4px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s;
    background: #000;
}

.avatar-item:hover {
    border-color: #888;
}

.avatar-item.selected {
    border-color: #ffd700;
    box-shadow: 0 0 5px #ffd700;
}

.avatar-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border: none;
}

/* 標籤 (例如 "預設") */
.avatar-item .label {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: rgba(0,0,0,0.7);
    color: white;
    font-size: 10px;
    text-align: center;
    padding: 2px 0;
}

/* 刪除按鈕 */
.avatar-item .delete-btn {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 20px;
    height: 20px;
    background: rgba(200, 0, 0, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 10px;
    display: flex; /* 預設顯示，或者改為 hover 才顯示 */
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
}

.avatar-item:hover .delete-btn {
    opacity: 1;
}